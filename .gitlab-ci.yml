variables:
  DEPENDENCIES: redhat-rpm-config meson git gettext gtk-doc meson glib2-devel libxml2-devel gobject-introspection-devel libgcrypt-devel libarchive-devel uchardet-devel
  DEPS_QUVI: libquvi-devel
  DEPS_ABI_CHECK: libabigail libsoup-devel gmime-devel
  TEST_DEPS: gvfs dbus-daemon shared-mime-info
  LAST_ABI_BREAK: "9ccc3c78a5a41b86bdd2c9fb63ad4963e65e4f63"

build-fedora:
  image: fedora:33
  before_script:
    # Update
    - dnf -y update && dnf install -y $DEPENDENCIES
  script:
    - meson _build
    - dnf install -y $TEST_DEPS
    - GIO_USE_VOLUME_MONITOR=unix dbus-run-session ninja -C _build test
    - ninja -C _build install
    # And now with quvi support
    - rm -rf _build
    - dnf install -y $DEPS_QUVI
    - meson _build
    - GIO_USE_VOLUME_MONITOR=unix dbus-run-session ninja -C _build test
    - ninja -C _build install
    # ABI check
    - dnf install -y $DEPS_ABI_CHECK
    # See https://sourceware.org/bugzilla/show_bug.cgi?id=27269
    - rpm -Uvh --oldpackage https://kojipkgs.fedoraproject.org//packages/libabigail/1.7/2.fc33/x86_64/libabigail-1.7-2.fc33.x86_64.rpm
    - ./.ci/check-abi ${LAST_ABI_BREAK} $(git rev-parse HEAD)
